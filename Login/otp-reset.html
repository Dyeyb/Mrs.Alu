<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Reset – Aluminum Lady</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=DM+Sans:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --gold: #b8935a;
            --gold-light: #d4aa72;
            --dark: #1a1a18;
            --surface: #1c1c1a;
            --surface2: #222220;
            --text: #e8e4dc;
            --muted: #888880;
            --border: rgba(184, 147, 90, 0.25);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
        }

        .form-card {
            width: 100%;
            max-width: 420px;
            animation: fadeUp 0.5s ease both;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ── STEPS ── */
        .steps {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2.5rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--muted);
            transition: all 0.3s ease;
        }

        .step.done .step-circle {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--dark);
        }

        .step.active .step-circle {
            background: transparent;
            border-color: var(--gold);
            color: var(--gold);
            box-shadow: 0 0 0 3px rgba(184, 147, 90, 0.15);
        }

        .step-label {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }

        .step.done .step-label,
        .step.active .step-label {
            color: var(--gold);
        }

        .step-line {
            width: 48px;
            height: 1px;
            background: var(--border);
            margin-bottom: 18px;
            transition: background 0.3s;
        }

        .step-line.done {
            background: rgba(184, 147, 90, 0.45);
        }

        /* ── HEADER ── */
        .form-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-header .tag {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 0.6rem;
            display: block;
        }

        .form-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .form-header p {
            font-size: 0.82rem;
            color: var(--muted);
            line-height: 1.6;
        }

        .email-badge {
            display: inline-block;
            margin-top: 6px;
            color: var(--gold);
            font-weight: 500;
            font-size: 0.83rem;
            background: rgba(184, 147, 90, 0.1);
            padding: 3px 10px;
            border-radius: 3px;
            border: 1px solid rgba(184, 147, 90, 0.22);
        }

        /* ── OTP INPUTS ── */
        .otp-group {
            display: flex;
            justify-content: center;
            gap: 0.55rem;
            margin-bottom: 1rem;
        }

        .otp-group input {
            width: 54px;
            height: 64px;
            text-align: center;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.75rem;
            font-weight: 600;
            background: var(--surface2);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-bottom: 2px solid rgba(184, 147, 90, 0.3);
            color: var(--text);
            outline: none;
            border-radius: 4px;
            caret-color: var(--gold);
            transition: border-color 0.2s, background 0.2s, transform 0.15s, box-shadow 0.2s;
        }

        .otp-group input:focus {
            border-color: var(--gold);
            border-bottom-color: var(--gold);
            background: #1e1e1c;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(184, 147, 90, 0.12);
        }

        .otp-group input.filled {
            border-bottom-color: var(--gold);
            color: var(--gold-light);
        }

        .otp-group input.error {
            border-color: #c0392b;
            border-bottom-color: #c0392b;
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
            animation: shake 0.4s ease;
        }

        .otp-group input.success {
            border-color: #54b066;
            border-bottom-color: #54b066;
            box-shadow: 0 0 0 3px rgba(84, 176, 102, 0.1);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-5px);
            }

            40% {
                transform: translateX(5px);
            }

            60% {
                transform: translateX(-3px);
            }

            80% {
                transform: translateX(3px);
            }
        }

        /* ── STATUS ── */
        .status-msg {
            text-align: center;
            font-size: 0.74rem;
            min-height: 1.1rem;
            margin-bottom: 0.55rem;
            transition: opacity 0.2s;
        }

        .status-msg.error {
            color: #e05454;
        }

        .status-msg.warning {
            color: #e09854;
        }

        .status-msg.success {
            color: #54b066;
        }

        .status-msg.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* ── TIMER ── */
        .timer-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            margin-bottom: 1.4rem;
        }

        .timer-ring-svg {
            flex-shrink: 0;
            transform: rotate(-90deg);
        }

        .timer-ring-bg {
            stroke: rgba(255, 255, 255, 0.07);
            fill: none;
        }

        .timer-ring-fill {
            fill: none;
            stroke: var(--gold);
            stroke-dasharray: 100;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
        }

        .timer-ring-fill.low {
            stroke: #e09854;
        }

        .timer-ring-fill.expired {
            stroke: #e05454;
        }

        .timer-text {
            font-size: 0.78rem;
            color: var(--muted);
        }

        .timer-val {
            font-weight: 500;
            color: var(--gold);
            transition: color 0.3s;
        }

        .timer-val.low {
            color: #e09854;
        }

        .timer-val.expired {
            color: #e05454;
        }

        /* ── RESEND ── */
        .resend-row {
            text-align: center;
            font-size: 0.78rem;
            color: var(--muted);
            margin-bottom: 1.6rem;
        }

        .resend-row button {
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--gold);
            padding: 0;
            border-bottom: 1px solid rgba(184, 147, 90, 0.3);
            transition: opacity 0.2s, border-color 0.2s;
        }

        .resend-row button:hover:not(:disabled) {
            opacity: 0.75;
            border-color: var(--gold);
        }

        .resend-row button:disabled {
            color: var(--muted);
            border-color: transparent;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ── BUTTONS ── */
        .btn-submit {
            width: 100%;
            padding: 0.95rem 1.5rem;
            background: var(--gold);
            color: #0e0e0c;
            border: none;
            border-radius: 4px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .btn-submit:hover:not(:disabled) {
            background: var(--gold-light);
            box-shadow: 0 4px 20px rgba(184, 147, 90, 0.35);
        }

        .btn-submit:active:not(:disabled) {
            transform: scale(0.995);
        }

        .btn-submit:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .btn-submit .btn-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(14, 14, 12, 0.3);
            border-top-color: #0e0e0c;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-submit.loading .btn-label {
            opacity: 0;
        }

        .btn-submit.loading .btn-spinner {
            display: block;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .btn-ghost {
            width: 100%;
            padding: 0.85rem;
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .btn-ghost:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ── TOAST ── */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(34, 34, 32, 0.92);
            backdrop-filter: blur(16px);
            border-left: 3px solid var(--gold);
            padding: 1rem 1.4rem;
            font-size: 0.82rem;
            color: var(--text);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);
            transform: translateX(20px);
            opacity: 0;
            transition: all 0.35s ease;
            pointer-events: none;
            z-index: 99;
            min-width: 200px;
            max-width: 320px;
            border-radius: 4px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        @media (max-width: 480px) {
            body {
                padding: 2rem 1.5rem;
            }

            .otp-group input {
                width: 44px;
                height: 56px;
                font-size: 1.4rem;
            }
        }
    </style>
</head>

<body>

    <div class="form-card">

        <!-- Step indicator -->
        <div class="steps">
            <div class="step done" id="step1">
                <div class="step-circle">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                </div>
                <span class="step-label">Email</span>
            </div>
            <div class="step-line done"></div>
            <div class="step active" id="step2">
                <div class="step-circle">2</div>
                <span class="step-label">Verify</span>
            </div>
            <div class="step-line" id="line2"></div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <span class="step-label">Reset</span>
            </div>
        </div>

        <div class="form-header">
            <span class="tag">Password Recovery</span>
            <h2>Check your inbox</h2>
            <p>
                We sent a 6-digit code to<br>
                <span class="email-badge" id="displayEmail">your email</span>
            </p>
        </div>

        <div class="otp-group" id="otpGroup">
            <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code" aria-label="Digit 1" />
            <input type="text" maxlength="1" inputmode="numeric" aria-label="Digit 2" />
            <input type="text" maxlength="1" inputmode="numeric" aria-label="Digit 3" />
            <input type="text" maxlength="1" inputmode="numeric" aria-label="Digit 4" />
            <input type="text" maxlength="1" inputmode="numeric" aria-label="Digit 5" />
            <input type="text" maxlength="1" inputmode="numeric" aria-label="Digit 6" />
        </div>

        <div class="status-msg hidden" id="statusMsg"></div>

        <!-- Countdown timer -->
        <div class="timer-wrap">
            <svg class="timer-ring-svg" width="30" height="30" viewBox="0 0 36 36">
                <circle class="timer-ring-bg" cx="18" cy="18" r="15.9" stroke-width="2.8" />
                <circle class="timer-ring-fill" cx="18" cy="18" r="15.9" stroke-width="2.8" id="timerRing" />
            </svg>
            <span class="timer-text">Code expires in <span class="timer-val" id="timerVal">10:00</span></span>
        </div>

        <div class="resend-row">
            Didn't receive it?&nbsp;
            <button id="resendBtn" disabled>
                Resend Code <span id="resendCd">(wait <span id="resendSec">30</span>s)</span>
            </button>
        </div>

        <button class="btn-submit" id="verifyBtn">
            <span class="btn-label">Verify Code</span>
            <div class="btn-spinner"></div>
        </button>
        <a href="forgot-password.html" class="btn-ghost">← Back</a>
        <!-- filename: otp-reset.html -->

    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ── Read session data ─────────────────────────────────────────────────────────
        let resetData = {};
        try {
            resetData = JSON.parse(sessionStorage.getItem('reset_user') || '{}');
        } catch (e) { }

        const userEmail = resetData.email || '';
        const userId = resetData.user_id || '';

        if (!userEmail) {
            window.location.href = 'forgot-password.html';
        } else {
            document.getElementById('displayEmail').textContent = userEmail;
        }

        // ── Toast ─────────────────────────────────────────────────────────────────────
        function showToast(msg, type = 'default') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            const map = { default: 'var(--gold)', error: '#e05454', success: '#54b066', warning: '#e09854' };
            t.style.borderLeftColor = map[type] || map.default;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3500);
        }

        // ── OTP input logic ───────────────────────────────────────────────────────────
        const inputs = Array.from(document.querySelectorAll('#otpGroup input'));

        inputs.forEach((input, i) => {
            input.addEventListener('keydown', e => {
                if (['Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) return;
                if (e.ctrlKey || e.metaKey) return;

                if (e.key === 'Backspace') {
                    if (input.value === '' && i > 0) {
                        inputs[i - 1].value = '';
                        inputs[i - 1].classList.remove('filled');
                        inputs[i - 1].focus();
                    } else {
                        input.classList.remove('filled');
                    }
                    clearStatus();
                    return;
                }
                if (e.key === 'Delete') return;

                if (!/^\d$/.test(e.key)) {
                    e.preventDefault();
                    setStatus('⚠ Numbers only (0–9)', 'warning');
                    return;
                }
                if (input.value.length >= 1) {
                    e.preventDefault();
                    if (i < inputs.length - 1) inputs[i + 1].focus();
                }
            });

            input.addEventListener('input', () => {
                input.value = input.value.replace(/\D/g, '').slice(0, 1);
                input.classList.toggle('filled', input.value !== '');
                inputs.forEach(inp => inp.classList.remove('error'));
                clearStatus();
                if (input.value && i < inputs.length - 1) inputs[i + 1].focus();
            });

            input.addEventListener('paste', e => {
                e.preventDefault();
                const digits = (e.clipboardData || window.clipboardData)
                    .getData('text').replace(/\D/g, '').slice(0, 6);
                digits.split('').forEach((d, idx) => {
                    if (inputs[idx]) { inputs[idx].value = d; inputs[idx].classList.add('filled'); }
                });
                inputs[Math.min(digits.length, inputs.length - 1)].focus();
            });
        });

        // ── Status ────────────────────────────────────────────────────────────────────
        function setStatus(msg, type = 'error') {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'status-msg ' + type;
        }
        function clearStatus() {
            const el = document.getElementById('statusMsg');
            el.className = 'status-msg hidden';
            el.textContent = '';
        }

        // ── Countdown Timer (10 min) ──────────────────────────────────────────────────
        const OTP_DURATION = 600;
        const CIRCUMFERENCE = 2 * Math.PI * 15.9;
        let timeLeft = OTP_DURATION;
        let timerInterval;
        const ring = document.getElementById('timerRing');
        ring.style.strokeDasharray = CIRCUMFERENCE;

        function updateTimer() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            const valEl = document.getElementById('timerVal');
            valEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

            const progress = timeLeft / OTP_DURATION;
            ring.style.strokeDashoffset = CIRCUMFERENCE * (1 - progress);

            ring.className = 'timer-ring-fill';
            valEl.className = 'timer-val';
            if (timeLeft <= 60) { ring.classList.add('low'); valEl.classList.add('low'); }
            if (timeLeft <= 30) { ring.classList.add('expired'); valEl.classList.add('expired'); }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('verifyBtn').disabled = true;
                setStatus('⚠ Code expired. Please request a new one.', 'error');
            }
            timeLeft--;
        }

        function startCountdown() {
            clearInterval(timerInterval);
            timeLeft = OTP_DURATION;
            document.getElementById('verifyBtn').disabled = false;
            clearStatus();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        startCountdown();

        // ── Resend cooldown (30s) ─────────────────────────────────────────────────────
        let resendCooldown = 30;
        let resendInterval;

        function startResendCooldown(seconds = 30) {
            const btn = document.getElementById('resendBtn');
            const cdEl = document.getElementById('resendCd');
            const secEl = document.getElementById('resendSec');
            resendCooldown = seconds;
            btn.disabled = true;
            cdEl.style.display = '';
            clearInterval(resendInterval);
            resendInterval = setInterval(() => {
                resendCooldown--;
                secEl.textContent = resendCooldown;
                if (resendCooldown <= 0) {
                    clearInterval(resendInterval);
                    btn.disabled = false;
                    cdEl.style.display = 'none';
                }
            }, 1000);
        }
        startResendCooldown();

        document.getElementById('resendBtn').addEventListener('click', async () => {
            const btn = document.getElementById('resendBtn');
            btn.disabled = true;
            showToast('Sending a new code…');
            inputs.forEach(inp => { inp.value = ''; inp.classList.remove('filled', 'error', 'success'); });
            clearStatus();

            try {
                const res = await fetch('resend-otp.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });
                const json = await res.json();

                if (json.success) {
                    showToast('New code sent!', 'success');
                    startCountdown();
                    startResendCooldown(30);
                    inputs[0].focus();
                } else {
                    showToast(json.message || 'Failed to resend.', 'error');
                    btn.disabled = false;
                }
            } catch (e) {
                showToast('Network error. Please try again.', 'error');
                btn.disabled = false;
            }
        });

        // ── Verify OTP ────────────────────────────────────────────────────────────────
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const code = inputs.map(i => i.value).join('');

            if (code.length < 6) {
                inputs.forEach(inp => inp.classList.add('error'));
                setStatus('⚠ Please enter the full 6-digit code.', 'error');
                return;
            }

            const btn = document.getElementById('verifyBtn');
            btn.classList.add('loading');
            btn.disabled = true;
            clearStatus();

            try {
                const res = await fetch('verify-otp.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, otp: code, flow: 'forgot-password' })
                });
                const json = await res.json();

                if (!json.success) {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    inputs.forEach(inp => inp.classList.add('error'));
                    setStatus('⚠ ' + (json.message || 'Invalid code. Please try again.'), 'error');
                    return;
                }

                // ── Verified: go to reset-password page ───────────────────────────────
                clearInterval(timerInterval);
                inputs.forEach(inp => inp.classList.add('success'));

                // Update step indicators
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('done');
                document.getElementById('step2').querySelector('.step-circle').innerHTML =
                    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                document.getElementById('line2').classList.add('done');
                document.getElementById('step3').classList.add('active');

                showToast('Code verified! Redirecting…', 'success');

                // Store verification token for reset page
                sessionStorage.setItem('reset_user', JSON.stringify({
                    email: userEmail,
                    user_id: userId,
                    verified: true,
                    flow: 'forgot-password'
                }));

                setTimeout(() => { window.location.href = 'reset-password.html'; }, 1200);

            } catch (e) {
                btn.classList.remove('loading');
                btn.disabled = false;
                setStatus('Network error. Please try again.', 'error');
            }
        });
    </script>

</body>

</html>